# Project_Akyuu 详细设计文档

## 1. 系统架构
- 前端：Vue 3（Vite/Pinia/Router，后续可按实际版本调整），与后端通过 REST API 交互，使用 JWT 存储于 HttpOnly Cookie 或 Authorization 头
- 后端：Java 1.8 + Spring Boot（Web, Validation, Security, Data JPA, Lombok, Jackson）
- 数据库：PostgreSQL 13+
- 存储：本地文件系统（初期），抽象存储接口，后续可扩展到对象存储
- 鉴权：Spring Security + JWT，基于角色（USER/ADMIN）与资源所有权校验
- 日志与监控：Spring Boot Actuator（后续），统一异常处理与审计日志

## 2. 领域模型与模块
- 账户与认证模块
  - 用户注册、登录、个人资料（昵称、头像）管理
  - JWT 发放/校验、密码加密（BCrypt）
- 相册模块
  - 公共相册（所有用户可见、可上传）
  - 私有相册（仅创建者与被邀请者可见）
  - 相册成员管理（邀请/移除）
  - 相册按上传日期排序/筛选
- 媒体模块（图片/视频）
  - 上传、在线预览、下载、删除（仅上传者可删）
  - 元数据：文件名、类型、大小、时长（视频）、宽高（图片）、存储路径/URL、所属相册、上传者、上传时间
- 评论模块
  - 对媒体评论与回复（支持多级，采用 parent_id 表示树形）

## 3. 数据库表结构（PostgreSQL）
命名风格：snake_case；时间统一使用 timestamptz；软删除可选（deleted_at）。

- users
  - id bigserial PK
  - username varchar(64) unique not null
  - password varchar(128) not null
  - nickname varchar(64) not null
  - avatar_url text null
  - role varchar(16) not null default 'USER'
  - created_at timestamptz not null default now()
  - updated_at timestamptz not null default now()

- albums
  - id bigserial PK
  - name varchar(128) not null
  - description text null
  - is_public boolean not null default true
  - owner_id bigint not null FK -> users(id)
  - created_at timestamptz not null default now()
  - updated_at timestamptz not null default now()
  - unique(owner_id, name)

- album_members
  - id bigserial PK
  - album_id bigint not null FK -> albums(id)
  - user_id bigint not null FK -> users(id)
  - role varchar(16) not null default 'MEMBER'  -- 可扩展 OWNER/EDITOR
  - created_at timestamptz not null default now()
  - unique(album_id, user_id)

- media
  - id bigserial PK
  - album_id bigint not null FK -> albums(id)
  - uploader_id bigint not null FK -> users(id)
  - title varchar(256) null
  - filename varchar(256) not null
  - content_type varchar(128) not null  -- image/jpeg, video/mp4
  - size_bytes bigint not null
  - width int null
  - height int null
  - duration_seconds int null
  - storage_path text not null  -- 本地相对路径或外部URL
  - thumbnail_path text null    -- 图片/视频预览图
  - created_at timestamptz not null default now()
  - updated_at timestamptz not null default now()
  - index(album_id, created_at)

- comments
  - id bigserial PK
  - media_id bigint not null FK -> media(id)
  - author_id bigint not null FK -> users(id)
  - parent_id bigint null FK -> comments(id)
  - content text not null
  - created_at timestamptz not null default now()
  - updated_at timestamptz not null default now()
  - index(media_id, created_at)

## 4. 权限与业务规则
- 公共相册：所有登录用户可见，可上传；删除权限仅限上传者或管理员
- 私有相册：仅相册所有者与成员可见与上传；删除权限仅限上传者或相册所有者/管理员
- 评论：作者可删/改，媒体上传者与相册所有者/管理员可管理不当评论
- 下载：对公共相册开放；对私有相册仅成员可下载

## 5. 接口设计（REST）
路径前缀：/api/v1；鉴权：除注册登录外均需 JWT。

- Auth
  - POST /auth/register {username,password,nickname,avatarUrl?}
  - POST /auth/login {username,password} -> {token,user}
  - GET  /auth/me -> 当前用户信息

- Users
  - GET  /users/{id}
  - PATCH /users/me {nickname,avatarUrl}

- Albums
  - POST /albums {name,description,isPublic}
  - GET  /albums/public?keyword=&page=&size=
  - GET  /albums/mine
  - GET  /albums/{id}
  - PATCH /albums/{id} {name,description,isPublic}
  - DELETE /albums/{id}
  - POST /albums/{id}/members {userId}
  - DELETE /albums/{id}/members/{userId}

- Media
  - POST /media/upload multipart{albumId,file,title?}
  - GET  /media/{id}
  - GET  /media/{id}/download
  - DELETE /media/{id}
  - GET  /albums/{id}/media?type=image|video&page=&size=&sort=createdAt,desc

- Comments
  - POST /media/{id}/comments {content,parentId?}
  - GET  /media/{id}/comments
  - PATCH /comments/{id} {content}
  - DELETE /comments/{id}

错误响应：统一 {code,message,details?}

## 6. 后端设计
- 分层：controller -> service -> repository -> entity -> dto/vo -> mapper
- 关键组件
  - SecurityConfig：JWT 过滤器、路径放行规则
  - StorageService：抽象存储接口 FileSystemStorageService 实现
  - MediaService：图片/视频元数据抽取（如宽高、时长，初期可选）
  - GlobalExceptionHandler：统一异常
  - Pageable/Sort：统一分页排序

## 7. 前端设计
- 路由
  - /login, /register
  - /albums/public, /albums/mine, /albums/:id
  - /media/:id 预览页
- 组件
  - Upload, MediaCard, CommentList, AlbumForm, MemberList
- 状态
  - userStore：登录态与用户信息
  - albumStore/mediaStore：分页与筛选

## 8. 文件存储布局（本地）
- uploads/
  - {albumId}/
    - {mediaId}-{originalFilename}
    - thumbs/{mediaId}.jpg

## 9. 非功能性
- 安全：输入校验，最大上传大小限制，文件类型白名单
- 性能：分页，缩略图，延迟加载
- 可维护：代码风格检查，日志追踪，请求ID

## 10. 部署与配置
- 配置项
  - spring.datasource.* 指向 PostgreSQL（192.168.1.6:5432, db=Akyuu, user=postgres, pass=sakuya）
  - storage.local.basePath=uploads
  - jwt.secret=环境变量注入
- 运行：后端 8080，前端 5173（示例）

## 11. 里程碑
- M1：鉴权+公共相册+媒体上传/预览/下载
- M2：私有相册与成员管理
- M3：评论与管理
- M4：前后端打通与验收
